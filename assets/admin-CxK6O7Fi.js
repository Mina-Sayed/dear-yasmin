const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CwZDPnQ5.js","assets/index-BuF_uRMX.css"])))=>i.map(i=>d[i]);
var T=Object.defineProperty;var A=(f,e,t)=>e in f?T(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var u=(f,e,t)=>A(f,typeof e!="symbol"?e+"":e,t);import{U as y,s as p,G as E,_ as k}from"./index-CwZDPnQ5.js";const l=class l{constructor(e){u(this,"sm");u(this,"eventListeners",[]);u(this,"photos",[]);u(this,"audio",null);this.sm=e}async enter(){y.showScreen("admin-screen"),this.eventListeners=[];try{await p.init()}catch(e){console.error("Failed to init storage:",e),alert("Cloud storage is not configured. Add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY, then redeploy."),await this.returnToIntro();return}this.setupEventListeners(),await this.loadExistingAssets(),this.updateUI()}setupEventListeners(){const e=document.getElementById("admin-photo-input"),t=document.getElementById("admin-add-photo");if(t&&e){const o=()=>e.click();t.addEventListener("click",o),this.eventListeners.push({el:t,type:"click",handler:o});const c=d=>{this.handlePhotoUpload(d)};e.addEventListener("change",c),this.eventListeners.push({el:e,type:"change",handler:c})}const s=document.getElementById("admin-audio-input"),i=document.getElementById("admin-add-audio");if(i&&s){const o=()=>s.click();i.addEventListener("click",o),this.eventListeners.push({el:i,type:"click",handler:o});const c=d=>{this.handleAudioUpload(d)};s.addEventListener("change",c),this.eventListeners.push({el:s,type:"change",handler:c})}const n=document.getElementById("admin-back");if(n){const o=()=>{this.returnToIntro()};n.addEventListener("click",o),this.eventListeners.push({el:n,type:"click",handler:o})}const a=document.getElementById("admin-reset");if(a){const o=()=>{this.resetToDefaults()};a.addEventListener("click",o),this.eventListeners.push({el:a,type:"click",handler:o})}}async handlePhotoUpload(e){const t=e.target,s=t.files;if(!s||s.length===0)return;const i=Array.from(s),n=i.slice(0,l.MAX_FILES_PER_UPLOAD),a=i.length-n.length,o=l.MAX_IMAGE_SIZE_MB*1024*1024;let c=0,d=0,x=0,g=0;for(let h=0;h<n.length;h++){const m=n[h];if(!this.isSupportedImageFile(m)){console.warn("Skipping non-image file:",m.name),c++;continue}if(m.size>o){console.warn(`Skipping large image (${this.formatSizeMB(m.size)}MB):`,m.name),d++;continue}const w=`photo_${Date.now()}_${Math.random().toString(36).slice(2,11)}`;try{await p.saveAsset(w,"photo",m.name,m),this.sm.audio.play("click"),x++}catch(I){console.error("Failed to save photo:",I),g++}(h+1)%l.YIELD_EVERY_UPLOADS===0&&await this.yieldToBrowser()}const r=[];x>0&&r.push(`Uploaded ${x} photo(s).`),a>0&&r.push(`Skipped ${a} (max ${l.MAX_FILES_PER_UPLOAD} per upload).`),d>0&&r.push(`Skipped ${d} large file(s) (max ${l.MAX_IMAGE_SIZE_MB}MB each).`),c>0&&r.push(`Skipped ${c} unsupported file(s).`),g>0&&r.push(`Failed ${g} upload(s).`),r.length>0&&alert(r.join(" ")),t.value="",await this.loadExistingAssets(),this.updateUI()}isSupportedImageFile(e){if(e.type.startsWith("image/"))return!0;const t=e.name.toLowerCase();return t.endsWith(".heic")||t.endsWith(".heif")}async handleAudioUpload(e){const t=e.target,s=t.files;if(!s||s.length===0)return;const i=s[0];if(!i.type.startsWith("audio/")){alert("Please select an audio file");return}this.audio&&await p.deleteAsset(this.audio.id);const n=`bgm_${Date.now()}`;try{await p.saveAsset(n,"audio",i.name,i),await p.setConfig("useCustomBGM",!0),this.sm.audio.play("click")}catch(a){console.error("Failed to save audio:",a)}t.value="",await this.loadExistingAssets(),this.updateUI()}async loadExistingAssets(){const e=await p.getAllAssets();this.photos=e.filter(t=>t.type==="photo"),this.audio=e.find(t=>t.type==="audio")||null}clearChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}createInfoMessage(e){const t=document.createElement("p");return t.style.cssText="color: #ffd166; text-align: center; font-size: 0.85rem; margin: 8px 0;",t.textContent=e,t}formatSizeMB(e){return(e/(1024*1024)).toFixed(1)}async yieldToBrowser(){await new Promise(e=>window.setTimeout(e,0))}createEmptyMessage(e){const t=document.createElement("p");return t.style.cssText="color: #888; text-align: center;",t.textContent=e,t}createPhotoItem(e,t){const s=document.createElement("div");s.className="admin-item",s.dataset.id=e.id,s.style.cssText="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px;";const i=document.createElement("div");i.style.cssText="display: flex; align-items: center; gap: 10px;";const n=document.createElement("img");n.src=e.url,n.style.cssText="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0;";const a=document.createElement("div");a.style.cssText="flex: 1; min-width: 0;";const o=document.createElement("div");o.style.cssText="font-size: 0.85rem; color: #888; margin-bottom: 4px;",o.textContent=`Slide ${t+1}`;const c=document.createElement("div");c.style.cssText="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",c.textContent=e.name,a.append(o,c);const d=document.createElement("button");d.className="admin-delete-photo",d.dataset.id=e.id,d.style.cssText="background: #e91e63; padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;",d.textContent="Delete",d.onclick=()=>{this.deletePhoto(e.id)},i.append(n,a,d);const x=document.createElement("div");x.style.cssText="display: flex; align-items: center; gap: 8px;";const g=document.createElement("span");g.style.cssText="font-size: 1rem;",g.textContent="ðŸ’¬";const r=document.createElement("input");r.type="text",r.className="admin-photo-text",r.dataset.id=e.id,r.value=e.text||"",r.placeholder="Enter a sweet message for this photo...",r.style.cssText="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 0.9rem;",r.onkeydown=m=>{m.key==="Enter"&&this.savePhotoText(e.id,r.value)};const h=document.createElement("button");return h.className="admin-save-text",h.dataset.id=e.id,h.style.cssText="background: #4caf50; padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;",h.textContent="Save",h.onclick=()=>{this.savePhotoText(e.id,r.value)},x.append(g,r,h),s.append(i,x),s}createAudioSection(e){const t=document.createElement("div"),s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;";const i=document.createElement("span");i.style.cssText="font-size: 1.5rem;",i.textContent="ðŸŽµ";const n=document.createElement("span");n.style.cssText="flex: 1; font-size: 0.9rem;",n.textContent=e.name;const a=document.createElement("button");a.style.cssText="background: #e91e63; padding: 6px 12px; font-size: 0.8rem;",a.textContent="Delete",a.onclick=()=>{this.deleteAudio()},s.append(i,n,a);const o=document.createElement("audio");return o.controls=!0,o.src=e.url,o.style.cssText="width: 100%; margin-top: 10px;",t.append(s,o),t}createPreviewItem(e,t){const s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);";const i=document.createElement("img");i.src=e.url,i.style.cssText="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; flex-shrink: 0;";const n=document.createElement("div");n.style.cssText="flex: 1; min-width: 0;";const a=document.createElement("div");a.style.cssText="font-size: 0.75rem; color: #888;",a.textContent=`Slide ${t+1}`;const o=document.createElement("div");return o.style.cssText="font-size: 0.9rem; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",o.textContent=e.text||"(no text)",n.append(a,o),s.append(i,n),s}updateUI(){const e=document.getElementById("admin-photo-list");if(e)if(this.clearChildren(e),this.photos.length===0)e.appendChild(this.createEmptyMessage("No photos uploaded yet"));else{const s=this.photos.slice(0,l.MAX_ADMIN_LIST_ITEMS);s.forEach((i,n)=>{e.appendChild(this.createPhotoItem(i,n))}),this.photos.length>s.length&&e.appendChild(this.createInfoMessage(`Showing first ${s.length} of ${this.photos.length} photos for performance.`))}const t=document.getElementById("admin-audio-info");t&&(this.clearChildren(t),this.audio?t.appendChild(this.createAudioSection(this.audio)):t.appendChild(this.createEmptyMessage("No custom audio uploaded"))),this.updatePreview()}updatePreview(){const e=document.getElementById("admin-preview");if(!e)return;if(this.clearChildren(e),this.photos.length===0){e.appendChild(this.createEmptyMessage("Upload photos to see preview"));return}const t=document.createElement("div");t.style.cssText="text-align: center; margin-bottom: 10px; color: var(--primary);",t.textContent=`Slideshow will show ${this.photos.length} photo(s)`;const s=document.createElement("div");s.style.cssText="max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;";const i=this.photos.slice(0,l.MAX_PREVIEW_ITEMS);i.forEach((n,a)=>{s.appendChild(this.createPreviewItem(n,a))}),this.photos.length>i.length&&s.appendChild(this.createInfoMessage(`Preview is limited to ${i.length} items (total: ${this.photos.length}).`)),e.append(t,s)}async deletePhoto(e){try{await p.deleteAsset(e),this.sm.audio.play("click"),await this.loadExistingAssets(),this.updateUI()}catch(t){console.error("Failed to delete photo:",t)}}async savePhotoText(e,t){try{await p.updatePhotoText(e,t),this.sm.audio.play("click");const s=document.querySelector(`.admin-save-text[data-id="${e}"]`);if(s){const n=s.innerText;s.innerText="âœ“ Saved",s.style.background="#2196f3",setTimeout(()=>{s.innerText=n,s.style.background="#4caf50"},1500)}const i=this.photos.find(n=>n.id===e);i&&(i.text=t),this.updatePreview()}catch(s){console.error("Failed to save photo text:",s),alert("Failed to save text")}}async deleteAudio(){if(this.audio)try{await p.deleteAsset(this.audio.id),await p.setConfig("useCustomBGM",!1),this.sm.audio.play("click"),await this.loadExistingAssets(),this.updateUI()}catch(e){console.error("Failed to delete audio:",e)}}async resetToDefaults(){if(confirm("This will delete all custom photos and audio. Continue?"))try{const e=await p.getAllAssets();for(const t of e)await p.deleteAsset(t.id);await p.setConfig("useCustomBGM",!1),this.photos=[],this.audio=null,this.sm.audio.play("click"),this.updateUI()}catch(e){console.error("Failed to reset:",e)}}async syncRuntimeContent(){try{await E.loadCustomContent()}catch(e){console.error("Failed to sync runtime content:",e),E.resetToDefaults()}this.sm.audio.setupBGM()}async returnToIntro(){await this.syncRuntimeContent();const{IntroState:e}=await k(async()=>{const{IntroState:t}=await import("./index-CwZDPnQ5.js").then(s=>s.i);return{IntroState:t}},__vite__mapDeps([0,1]));this.sm.changeState(new e(this.sm))}update(e){}draw(e){e.clear("#1a1a2e")}exit(){this.eventListeners.forEach(({el:e,type:t,handler:s})=>{e.removeEventListener(t,s)}),this.eventListeners=[],y.hideScreen("admin-screen")}resize(e,t){}};u(l,"MAX_FILES_PER_UPLOAD",24),u(l,"MAX_IMAGE_SIZE_MB",12),u(l,"MAX_ADMIN_LIST_ITEMS",30),u(l,"MAX_PREVIEW_ITEMS",20),u(l,"YIELD_EVERY_UPLOADS",3);let v=l;export{v as AdminState};
