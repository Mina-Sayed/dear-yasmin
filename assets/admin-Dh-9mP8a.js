const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DtXWMLb9.js","assets/index-BuF_uRMX.css"])))=>i.map(i=>d[i]);
var v=Object.defineProperty;var w=(h,e,t)=>e in h?v(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var u=(h,e,t)=>w(h,typeof e!="symbol"?e+"":e,t);import{U as g,s as d,G as f,_ as E}from"./index-DtXWMLb9.js";class C{constructor(e){u(this,"sm");u(this,"eventListeners",[]);u(this,"photos",[]);u(this,"audio",null);this.sm=e}async enter(){g.showScreen("admin-screen"),this.eventListeners=[];try{await d.init()}catch(e){console.error("Failed to init storage:",e),alert("Cloud storage is not configured. Add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY, then redeploy."),await this.returnToIntro();return}this.setupEventListeners(),await this.loadExistingAssets(),this.updateUI()}setupEventListeners(){const e=document.getElementById("admin-photo-input"),t=document.getElementById("admin-add-photo");if(t&&e){const o=()=>e.click();t.addEventListener("click",o),this.eventListeners.push({el:t,type:"click",handler:o});const l=r=>{this.handlePhotoUpload(r)};e.addEventListener("change",l),this.eventListeners.push({el:e,type:"change",handler:l})}const s=document.getElementById("admin-audio-input"),n=document.getElementById("admin-add-audio");if(n&&s){const o=()=>s.click();n.addEventListener("click",o),this.eventListeners.push({el:n,type:"click",handler:o});const l=r=>{this.handleAudioUpload(r)};s.addEventListener("change",l),this.eventListeners.push({el:s,type:"change",handler:l})}const i=document.getElementById("admin-back");if(i){const o=()=>{this.returnToIntro()};i.addEventListener("click",o),this.eventListeners.push({el:i,type:"click",handler:o})}const a=document.getElementById("admin-reset");if(a){const o=()=>{this.resetToDefaults()};a.addEventListener("click",o),this.eventListeners.push({el:a,type:"click",handler:o})}}async handlePhotoUpload(e){const t=e.target,s=t.files;if(!(!s||s.length===0)){for(const n of Array.from(s)){if(!this.isSupportedImageFile(n)){console.warn("Skipping non-image file:",n.name);continue}const i=`photo_${Date.now()}_${Math.random().toString(36).slice(2,11)}`;try{await d.saveAsset(i,"photo",n.name,n),this.sm.audio.play("click")}catch(a){console.error("Failed to save photo:",a)}}t.value="",await this.loadExistingAssets(),this.updateUI()}}isSupportedImageFile(e){if(e.type.startsWith("image/"))return!0;const t=e.name.toLowerCase();return t.endsWith(".heic")||t.endsWith(".heif")}async handleAudioUpload(e){const t=e.target,s=t.files;if(!s||s.length===0)return;const n=s[0];if(!n.type.startsWith("audio/")){alert("Please select an audio file");return}this.audio&&await d.deleteAsset(this.audio.id);const i=`bgm_${Date.now()}`;try{await d.saveAsset(i,"audio",n.name,n),await d.setConfig("useCustomBGM",!0),this.sm.audio.play("click")}catch(a){console.error("Failed to save audio:",a)}t.value="",await this.loadExistingAssets(),this.updateUI()}async loadExistingAssets(){const e=await d.getAllAssets();this.photos=e.filter(t=>t.type==="photo"),this.audio=e.find(t=>t.type==="audio")||null}clearChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}createEmptyMessage(e){const t=document.createElement("p");return t.style.cssText="color: #888; text-align: center;",t.textContent=e,t}createPhotoItem(e,t){const s=document.createElement("div");s.className="admin-item",s.dataset.id=e.id,s.style.cssText="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px;";const n=document.createElement("div");n.style.cssText="display: flex; align-items: center; gap: 10px;";const i=document.createElement("img");i.src=e.url,i.style.cssText="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0;";const a=document.createElement("div");a.style.cssText="flex: 1; min-width: 0;";const o=document.createElement("div");o.style.cssText="font-size: 0.85rem; color: #888; margin-bottom: 4px;",o.textContent=`Slide ${t+1}`;const l=document.createElement("div");l.style.cssText="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",l.textContent=e.name,a.append(o,l);const r=document.createElement("button");r.className="admin-delete-photo",r.dataset.id=e.id,r.style.cssText="background: #e91e63; padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;",r.textContent="Delete",r.onclick=()=>{this.deletePhoto(e.id)},n.append(i,a,r);const m=document.createElement("div");m.style.cssText="display: flex; align-items: center; gap: 8px;";const x=document.createElement("span");x.style.cssText="font-size: 1rem;",x.textContent="ðŸ’¬";const c=document.createElement("input");c.type="text",c.className="admin-photo-text",c.dataset.id=e.id,c.value=e.text||"",c.placeholder="Enter a sweet message for this photo...",c.style.cssText="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 0.9rem;",c.onkeydown=y=>{y.key==="Enter"&&this.savePhotoText(e.id,c.value)};const p=document.createElement("button");return p.className="admin-save-text",p.dataset.id=e.id,p.style.cssText="background: #4caf50; padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;",p.textContent="Save",p.onclick=()=>{this.savePhotoText(e.id,c.value)},m.append(x,c,p),s.append(n,m),s}createAudioSection(e){const t=document.createElement("div"),s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;";const n=document.createElement("span");n.style.cssText="font-size: 1.5rem;",n.textContent="ðŸŽµ";const i=document.createElement("span");i.style.cssText="flex: 1; font-size: 0.9rem;",i.textContent=e.name;const a=document.createElement("button");a.style.cssText="background: #e91e63; padding: 6px 12px; font-size: 0.8rem;",a.textContent="Delete",a.onclick=()=>{this.deleteAudio()},s.append(n,i,a);const o=document.createElement("audio");return o.controls=!0,o.src=e.url,o.style.cssText="width: 100%; margin-top: 10px;",t.append(s,o),t}createPreviewItem(e,t){const s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);";const n=document.createElement("img");n.src=e.url,n.style.cssText="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; flex-shrink: 0;";const i=document.createElement("div");i.style.cssText="flex: 1; min-width: 0;";const a=document.createElement("div");a.style.cssText="font-size: 0.75rem; color: #888;",a.textContent=`Slide ${t+1}`;const o=document.createElement("div");return o.style.cssText="font-size: 0.9rem; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",o.textContent=e.text||"(no text)",i.append(a,o),s.append(n,i),s}updateUI(){const e=document.getElementById("admin-photo-list");e&&(this.clearChildren(e),this.photos.length===0?e.appendChild(this.createEmptyMessage("No photos uploaded yet")):this.photos.forEach((s,n)=>{e.appendChild(this.createPhotoItem(s,n))}));const t=document.getElementById("admin-audio-info");t&&(this.clearChildren(t),this.audio?t.appendChild(this.createAudioSection(this.audio)):t.appendChild(this.createEmptyMessage("No custom audio uploaded"))),this.updatePreview()}updatePreview(){const e=document.getElementById("admin-preview");if(!e)return;if(this.clearChildren(e),this.photos.length===0){e.appendChild(this.createEmptyMessage("Upload photos to see preview"));return}const t=document.createElement("div");t.style.cssText="text-align: center; margin-bottom: 10px; color: var(--primary);",t.textContent=`Slideshow will show ${this.photos.length} photo(s)`;const s=document.createElement("div");s.style.cssText="max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;",this.photos.forEach((n,i)=>{s.appendChild(this.createPreviewItem(n,i))}),e.append(t,s)}async deletePhoto(e){try{await d.deleteAsset(e),this.sm.audio.play("click"),await this.loadExistingAssets(),this.updateUI()}catch(t){console.error("Failed to delete photo:",t)}}async savePhotoText(e,t){try{await d.updatePhotoText(e,t),this.sm.audio.play("click");const s=document.querySelector(`.admin-save-text[data-id="${e}"]`);if(s){const i=s.innerText;s.innerText="âœ“ Saved",s.style.background="#2196f3",setTimeout(()=>{s.innerText=i,s.style.background="#4caf50"},1500)}const n=this.photos.find(i=>i.id===e);n&&(n.text=t),this.updatePreview()}catch(s){console.error("Failed to save photo text:",s),alert("Failed to save text")}}async deleteAudio(){if(this.audio)try{await d.deleteAsset(this.audio.id),await d.setConfig("useCustomBGM",!1),this.sm.audio.play("click"),await this.loadExistingAssets(),this.updateUI()}catch(e){console.error("Failed to delete audio:",e)}}async resetToDefaults(){if(confirm("This will delete all custom photos and audio. Continue?"))try{const e=await d.getAllAssets();for(const t of e)await d.deleteAsset(t.id);await d.setConfig("useCustomBGM",!1),this.photos=[],this.audio=null,this.sm.audio.play("click"),this.updateUI()}catch(e){console.error("Failed to reset:",e)}}async syncRuntimeContent(){try{await f.loadCustomContent()}catch(e){console.error("Failed to sync runtime content:",e),f.resetToDefaults()}this.sm.audio.setupBGM()}async returnToIntro(){await this.syncRuntimeContent();const{IntroState:e}=await E(async()=>{const{IntroState:t}=await import("./index-DtXWMLb9.js").then(s=>s.i);return{IntroState:t}},__vite__mapDeps([0,1]));this.sm.changeState(new e(this.sm))}update(e){}draw(e){e.clear("#1a1a2e")}exit(){this.eventListeners.forEach(({el:e,type:t,handler:s})=>{e.removeEventListener(t,s)}),this.eventListeners=[],g.hideScreen("admin-screen")}resize(e,t){}}export{C as AdminState};
