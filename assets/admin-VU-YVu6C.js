const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DiEkNb_I.js","assets/index-BuF_uRMX.css"])))=>i.map(i=>d[i]);
var w=Object.defineProperty;var P=(x,e,t)=>e in x?w(x,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):x[e]=t;var m=(x,e,t)=>P(x,typeof e!="symbol"?e+"":e,t);import{U as f,s as l,G as E,_ as I}from"./index-DiEkNb_I.js";const r=class r{constructor(e){m(this,"sm");m(this,"eventListeners",[]);m(this,"photos",[]);m(this,"audio",null);m(this,"adminPage",1);m(this,"previewPage",1);this.sm=e}async enter(){f.showScreen("admin-screen"),this.eventListeners=[];try{await l.init()}catch(e){console.error("Failed to init storage:",e),alert("Cloud storage is not configured. Add VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY, then redeploy."),await this.returnToIntro();return}this.setupEventListeners(),await this.loadExistingAssets(),this.updateUI()}setupEventListeners(){const e=document.getElementById("admin-photo-input"),t=document.getElementById("admin-add-photo");if(t&&e){const n=()=>e.click();t.addEventListener("click",n),this.eventListeners.push({el:t,type:"click",handler:n});const c=d=>{this.handlePhotoUpload(d)};e.addEventListener("change",c),this.eventListeners.push({el:e,type:"change",handler:c})}const s=document.getElementById("admin-audio-input"),a=document.getElementById("admin-add-audio");if(a&&s){const n=()=>s.click();a.addEventListener("click",n),this.eventListeners.push({el:a,type:"click",handler:n});const c=d=>{this.handleAudioUpload(d)};s.addEventListener("change",c),this.eventListeners.push({el:s,type:"change",handler:c})}const i=document.getElementById("admin-back");if(i){const n=()=>{this.returnToIntro()};i.addEventListener("click",n),this.eventListeners.push({el:i,type:"click",handler:n})}const o=document.getElementById("admin-reset");if(o){const n=()=>{this.resetToDefaults()};o.addEventListener("click",n),this.eventListeners.push({el:o,type:"click",handler:n})}}async handlePhotoUpload(e){const t=e.target,s=t.files;if(!s||s.length===0)return;const a=r.MAX_IMAGE_SIZE_MB*1024*1024;let i=0,o=0,n=0,c=0;for(let u=0;u<s.length;u++){const h=s[u];if(!this.isSupportedImageFile(h)){console.warn("Skipping non-image file:",h.name),n++;continue}if(h.size>a){console.warn("Skipping large image file:",h.name,h.size),o++;continue}const p=`photo_${Date.now()}_${Math.random().toString(36).slice(2,11)}`;try{await l.saveAsset(p,"photo",h.name,h),this.sm.audio.play("click"),i++}catch(g){console.error("Failed to save photo:",g),c++}(u+1)%r.YIELD_EVERY_UPLOADS===0&&await this.yieldToBrowser()}const d=[];i>0&&d.push(`Uploaded ${i} photo(s).`),o>0&&d.push(`Skipped ${o} file(s) larger than ${r.MAX_IMAGE_SIZE_MB}MB.`),n>0&&d.push(`Skipped ${n} unsupported file(s).`),c>0&&d.push(`Failed ${c} upload(s).`),d.length>0&&alert(d.join(" ")),t.value="",await this.loadExistingAssets(),this.goToLastAdminPage(),this.goToLastPreviewPage(),this.updateUI()}isSupportedImageFile(e){if(e.type.startsWith("image/"))return!0;const t=e.name.toLowerCase();return t.endsWith(".heic")||t.endsWith(".heif")}async handleAudioUpload(e){const t=e.target,s=t.files;if(!s||s.length===0)return;const a=s[0];if(!a.type.startsWith("audio/")){alert("Please select an audio file");return}this.audio&&await l.deleteAsset(this.audio.id);const i=`bgm_${Date.now()}`;try{await l.saveAsset(i,"audio",a.name,a),await l.setConfig("useCustomBGM",!0),this.sm.audio.play("click")}catch(o){console.error("Failed to save audio:",o)}t.value="",await this.loadExistingAssets(),this.updateUI()}async loadExistingAssets(){const e=await l.getAllAssets();this.photos=e.filter(t=>t.type==="photo"),this.audio=e.find(t=>t.type==="audio")||null,this.clampPages()}clearChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}createEmptyMessage(e){const t=document.createElement("p");return t.style.cssText="color: #888; text-align: center;",t.textContent=e,t}async yieldToBrowser(){await new Promise(e=>window.setTimeout(e,0))}totalPages(e){return Math.max(1,Math.ceil(this.photos.length/e))}clampPages(){this.adminPage=Math.min(Math.max(1,this.adminPage),this.totalPages(r.ADMIN_PAGE_SIZE)),this.previewPage=Math.min(Math.max(1,this.previewPage),this.totalPages(r.PREVIEW_PAGE_SIZE))}goToLastAdminPage(){this.adminPage=this.totalPages(r.ADMIN_PAGE_SIZE)}goToLastPreviewPage(){this.previewPage=this.totalPages(r.PREVIEW_PAGE_SIZE)}getPhotoSlice(e,t){const s=(e-1)*t;return{start:s,items:this.photos.slice(s,s+t)}}createPagination(e,t,s){const a=document.createElement("div");a.style.cssText="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px;";const i=document.createElement("button");i.textContent="Prev",i.disabled=e<=1,i.style.cssText="padding: 6px 10px; font-size: 0.8rem;",i.onclick=()=>{e>1&&s(e-1)};const o=document.createElement("span");o.style.cssText="font-size: 0.85rem; color: #ddd; min-width: 90px; text-align: center;",o.textContent=`Page ${e} / ${t}`;const n=document.createElement("button");return n.textContent="Next",n.disabled=e>=t,n.style.cssText="padding: 6px 10px; font-size: 0.8rem;",n.onclick=()=>{e<t&&s(e+1)},a.append(i,o,n),a}createPhotoItem(e,t){const s=document.createElement("div");s.className="admin-item",s.dataset.id=e.id,s.style.cssText="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 10px;";const a=document.createElement("div");a.style.cssText="display: flex; align-items: center; gap: 10px;";const i=document.createElement("img");i.src=e.url,i.style.cssText="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0;";const o=document.createElement("div");o.style.cssText="flex: 1; min-width: 0;";const n=document.createElement("div");n.style.cssText="font-size: 0.85rem; color: #888; margin-bottom: 4px;",n.textContent=`Slide ${t+1}`;const c=document.createElement("div");c.style.cssText="font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",c.textContent=e.name,o.append(n,c);const d=document.createElement("button");d.className="admin-delete-photo",d.dataset.id=e.id,d.style.cssText="background: #e91e63; padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;",d.textContent="Delete",d.onclick=()=>{this.deletePhoto(e.id)},a.append(i,o,d);const u=document.createElement("div");u.style.cssText="display: flex; align-items: center; gap: 8px;";const h=document.createElement("span");h.style.cssText="font-size: 1rem;",h.textContent="ðŸ’¬";const p=document.createElement("input");p.type="text",p.className="admin-photo-text",p.dataset.id=e.id,p.value=e.text||"",p.placeholder="Enter a sweet message for this photo...",p.style.cssText="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; font-size: 0.9rem;",p.onkeydown=v=>{v.key==="Enter"&&this.savePhotoText(e.id,p.value)};const g=document.createElement("button");return g.className="admin-save-text",g.dataset.id=e.id,g.style.cssText="background: #4caf50; padding: 6px 12px; font-size: 0.8rem; flex-shrink: 0;",g.textContent="Save",g.onclick=()=>{this.savePhotoText(e.id,p.value)},u.append(h,p,g),s.append(a,u),s}createAudioSection(e){const t=document.createElement("div"),s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;";const a=document.createElement("span");a.style.cssText="font-size: 1.5rem;",a.textContent="ðŸŽµ";const i=document.createElement("span");i.style.cssText="flex: 1; font-size: 0.9rem;",i.textContent=e.name;const o=document.createElement("button");o.style.cssText="background: #e91e63; padding: 6px 12px; font-size: 0.8rem;",o.textContent="Delete",o.onclick=()=>{this.deleteAudio()},s.append(a,i,o);const n=document.createElement("audio");return n.controls=!0,n.src=e.url,n.style.cssText="width: 100%; margin-top: 10px;",t.append(s,n),t}createPreviewItem(e,t){const s=document.createElement("div");s.style.cssText="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);";const a=document.createElement("img");a.src=e.url,a.style.cssText="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; flex-shrink: 0;";const i=document.createElement("div");i.style.cssText="flex: 1; min-width: 0;";const o=document.createElement("div");o.style.cssText="font-size: 0.75rem; color: #888;",o.textContent=`Slide ${t+1}`;const n=document.createElement("div");return n.style.cssText="font-size: 0.9rem; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",n.textContent=e.text||"(no text)",i.append(o,n),s.append(a,i),s}updateUI(){const e=document.getElementById("admin-photo-list");if(e)if(this.clearChildren(e),this.photos.length===0)e.appendChild(this.createEmptyMessage("No photos uploaded yet"));else{const s=this.totalPages(r.ADMIN_PAGE_SIZE),a=this.getPhotoSlice(this.adminPage,r.ADMIN_PAGE_SIZE);a.items.forEach((i,o)=>{e.appendChild(this.createPhotoItem(i,a.start+o))}),e.appendChild(this.createPagination(this.adminPage,s,i=>{this.adminPage=i,this.updateUI()}))}const t=document.getElementById("admin-audio-info");t&&(this.clearChildren(t),this.audio?t.appendChild(this.createAudioSection(this.audio)):t.appendChild(this.createEmptyMessage("No custom audio uploaded"))),this.updatePreview()}updatePreview(){const e=document.getElementById("admin-preview");if(!e)return;if(this.clearChildren(e),this.photos.length===0){e.appendChild(this.createEmptyMessage("Upload photos to see preview"));return}const t=document.createElement("div");t.style.cssText="text-align: center; margin-bottom: 10px; color: var(--primary);",t.textContent=`Slideshow will show ${this.photos.length} photo(s)`;const s=document.createElement("div");s.style.cssText="max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;";const a=this.totalPages(r.PREVIEW_PAGE_SIZE),i=this.getPhotoSlice(this.previewPage,r.PREVIEW_PAGE_SIZE);i.items.forEach((o,n)=>{s.appendChild(this.createPreviewItem(o,i.start+n))}),e.append(t,s,this.createPagination(this.previewPage,a,o=>{this.previewPage=o,this.updatePreview()}))}async deletePhoto(e){try{await l.deleteAsset(e),this.sm.audio.play("click"),await this.loadExistingAssets(),this.updateUI()}catch(t){console.error("Failed to delete photo:",t)}}async savePhotoText(e,t){try{await l.updatePhotoText(e,t),this.sm.audio.play("click");const s=document.querySelector(`.admin-save-text[data-id="${e}"]`);if(s){const i=s.innerText;s.innerText="âœ“ Saved",s.style.background="#2196f3",setTimeout(()=>{s.innerText=i,s.style.background="#4caf50"},1500)}const a=this.photos.find(i=>i.id===e);a&&(a.text=t),this.updatePreview()}catch(s){console.error("Failed to save photo text:",s),alert("Failed to save text")}}async deleteAudio(){if(this.audio)try{await l.deleteAsset(this.audio.id),await l.setConfig("useCustomBGM",!1),this.sm.audio.play("click"),await this.loadExistingAssets(),this.updateUI()}catch(e){console.error("Failed to delete audio:",e)}}async resetToDefaults(){if(confirm("This will delete all custom photos and audio. Continue?"))try{const e=await l.getAllAssets();for(const t of e)await l.deleteAsset(t.id);await l.setConfig("useCustomBGM",!1),this.photos=[],this.audio=null,this.sm.audio.play("click"),this.updateUI()}catch(e){console.error("Failed to reset:",e)}}async syncRuntimeContent(){try{await E.loadCustomContent()}catch(e){console.error("Failed to sync runtime content:",e),E.resetToDefaults()}this.sm.audio.setupBGM()}async returnToIntro(){await this.syncRuntimeContent();const{IntroState:e}=await I(async()=>{const{IntroState:t}=await import("./index-DiEkNb_I.js").then(s=>s.i);return{IntroState:t}},__vite__mapDeps([0,1]));this.sm.changeState(new e(this.sm))}update(e){}draw(e){e.clear("#1a1a2e")}exit(){this.eventListeners.forEach(({el:e,type:t,handler:s})=>{e.removeEventListener(t,s)}),this.eventListeners=[],f.hideScreen("admin-screen")}resize(e,t){}};m(r,"ADMIN_PAGE_SIZE",12),m(r,"PREVIEW_PAGE_SIZE",15),m(r,"MAX_IMAGE_SIZE_MB",15),m(r,"YIELD_EVERY_UPLOADS",3);let y=r;export{y as AdminState};
